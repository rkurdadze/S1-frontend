<section class="admin-page">
  <header class="admin-page__header">
    <div>
      <p class="admin-page__eyebrow">{{ 'admin.items.eyebrow' | translate }}</p>
      <h2>{{ 'admin.items.title' | translate }}</h2>
      <p class="admin-page__subtitle">{{ 'admin.items.subtitle' | translate }}</p>
    </div>
    <button class="admin-button admin-button--primary admin-button--create" type="button" (click)="toggleCreateForm()">
      {{ showCreateForm ? ('admin.items.hide_form' | translate) : ('admin.items.create_item' | translate) }}
    </button>
  </header>

  <div class="admin-grid">
    <!-- CREATE FORM -->
    <section class="admin-card admin-card--editor" *ngIf="showCreateForm">
      <div class="admin-card__header">
        <div class="admin-card__title-group">
          <h3>{{ 'admin.items.new_card' | translate }}</h3>
          <span class="admin-pill">{{ 'admin.items.creating' | translate }}</span>
        </div>
        <div class="admin-card__header-actions">
          <button class="admin-button admin-button--primary" type="button" (click)="onSaveItem()">
            <i class="fas fa-check"></i>
            {{ 'admin.items.create_item' | translate }}
          </button>
          <button class="admin-button admin-button--ghost" type="button" (click)="cancelEdit()">
            <i class="fas fa-times"></i>
            {{ 'admin.items.cancel_edit' | translate }}
          </button>
        </div>
      </div>
      <div class="admin-form">
        <ng-container *ngTemplateOutlet="itemFormFields"></ng-container>
        <ng-container *ngTemplateOutlet="imagePanel"></ng-container>
        <ng-container *ngTemplateOutlet="tagsSection"></ng-container>
      </div>
    </section>

    <!-- LIST -->
    <section class="admin-card admin-card--list">
      <div class="admin-card__header admin-card__header--with-search">
        <div>
          <h3>{{ 'admin.items.list_title' | translate }}</h3>
          <span class="admin-pill">{{ 'admin.items.in_database' | translate: { count: items.length } }}</span>
        </div>
        <label class="admin-search">
          <span class="admin-search__icon" aria-hidden="true">ğŸ”</span>
          <input
            type="search"
            name="itemSearch"
            [(ngModel)]="searchTerm"
            [placeholder]="'admin.items.search_placeholder' | translate"
          />
        </label>
      </div>
      
      <p class="admin-empty" *ngIf="isLoading">{{ 'admin.items.loading' | translate }}</p>
      
      <div class="admin-list" *ngIf="filteredItems.length; else emptyItems">
        <ng-container *ngFor="let item of filteredItems">
          <article class="admin-list__item" [class.is-active]="item.id === editingItemId">
            <div class="admin-list__row">
              <div class="admin-list__main">
                <div>
                  <h4>{{ item.name }}</h4>
                  <p class="admin-list__meta">{{ 'admin.items.id' | translate }} {{ item.id }} â€¢ {{ (item.publish ? 'admin.items.published' : 'admin.items.draft') | translate }}</p>
                  <div class="admin-list__tags" *ngIf="item.tags?.length">
                    <span class="admin-chip" *ngFor="let tag of item.tags">{{ tag }}</span>
                  </div>
                </div>
                <div class="admin-list__previews">
                  <div class="admin-preview" *ngFor="let preview of getColorPreviews(item)">
                    <span class="admin-preview__swatch" [style.background]="preview.color"></span>
                    <img *ngIf="preview.image" [src]="preview.image" [alt]="preview.color" />
                    <span *ngIf="!preview.image" class="admin-preview__placeholder">{{ 'admin.items.no_photo' | translate }}</span>
                  </div>
                </div>
              </div>
              
              <div class="admin-list__stats">
                <span class="admin-chip">{{ (item.publish ? 'admin.items.in_sale' : 'admin.items.hidden') | translate }}</span>
                <span class="admin-list__price">{{ 'admin.items.colors_count' | translate: { count: item.colors.length || 0 } }}</span>
                <div class="admin-list__actions">
                  <ng-template #editAction>
                    <button class="admin-icon-button admin-icon-button--edit" type="button" (click)="$event.stopPropagation(); startEdit(item)" [title]="'admin.items.edit' | translate">
                      <i class="fas fa-edit"></i>
                    </button>
                  </ng-template>
                  
                  <ng-container *ngIf="editingItemId === item.id; else editAction">
                    <span class="admin-pill">{{ 'admin.items.editing' | translate }}</span>
                  </ng-container>

                  <button class="admin-icon-button admin-icon-button--delete" type="button" (click)="$event.stopPropagation(); onDeleteItem(item)" [title]="'admin.items.delete' | translate">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- EDIT PANEL -->
            <div class="admin-inline-panel" *ngIf="selectedItem?.id === item.id && editingItemId === item.id && !showCreateForm">
              <div class="admin-card__header">
                <div class="admin-card__title-group">
                  <h3>{{ 'admin.items.editing' | translate }}</h3>
                  <span class="admin-pill">{{ 'admin.items.id' | translate }} {{ selectedItem?.id }}</span>
                </div>
                <div class="admin-card__header-actions">
                  <button class="admin-button admin-button--primary" type="button" (click)="onSaveItem()">
                    <i class="fas fa-check"></i>
                    {{ 'admin.items.save_changes' | translate }}
                  </button>
                  <button class="admin-button admin-button--ghost" type="button" (click)="cancelEdit()">
                    <i class="fas fa-times"></i>
                    {{ 'admin.items.cancel_edit' | translate }}
                  </button>
                </div>
              </div>
              <div class="admin-form">
                <ng-container *ngTemplateOutlet="itemFormFields"></ng-container>
                <ng-container *ngTemplateOutlet="imagePanel"></ng-container>
                <ng-container *ngTemplateOutlet="tagsSection"></ng-container>
              </div>
            </div>
          </article>
        </ng-container>
      </div>
      <ng-template #emptyItems>
        <p class="admin-empty">{{ (searchTerm ? 'admin.items.no_results' : 'admin.items.no_items') | translate }}</p>
      </ng-template>
    </section>
  </div>
</section>

<!-- REUSABLE TEMPLATES -->

<ng-template #itemFormFields>
  <div class="admin-form__row">
    <label>
      {{ 'admin.items.name' | translate }}
      <input type="text" name="itemName" [(ngModel)]="itemForm.name" />
    </label>
    <label>
      {{ 'admin.items.price' | translate }}
      <input type="number" name="itemPrice" [(ngModel)]="itemForm.price" />
    </label>
  </div>
  
  <div class="admin-form__row admin-form__row--description">
    <label>
      {{ 'admin.items.description' | translate }}
      <textarea name="itemDescription" [(ngModel)]="itemForm.description"></textarea>
    </label>

    <div class="selector-block">
      <p class="selector-label">{{ 'admin.items.color_palette' | translate }}</p>
      <app-item-colors
        [colors]="selectedItem?.colors ?? []"
        [itemId]="selectedItem?.id!"
        [isAdmin]="true"
        (selectedColorEmitter)="onColorSelected($event)"
      ></app-item-colors>
    </div>
    
    <div class="selector-block">
      <p class="selector-label">{{ 'admin.items.sizes_and_availability' | translate }}</p>
      <app-item-sizes
        [item]="selectedItem!"
        [forColor]="selectedColor"
        [isAdmin]="true"
      ></app-item-sizes>
    </div>
  </div>
  
  <label class="admin-checkbox">
    <input type="checkbox" name="itemPublish" [(ngModel)]="itemForm.publish" />
    {{ (showCreateForm ? 'admin.items.publish_immediately' : 'admin.items.published') | translate }}
  </label>
</ng-template>

<ng-template #tagsSection>
  <div class="admin-form__tags" style="margin-top: 1rem;">
    <label>{{ 'admin.items.tags_label' | translate }}</label>
    <div class="tags-cloud">
      <button 
        type="button" 
        class="tag-chip" 
        *ngFor="let tag of tags" 
        [class.active]="isTagActive(tag)"
        (click)="toggleTag(tag)">
        {{ tag }}
      </button>
    </div>
  </div>
</ng-template>

<ng-template #imagePanel>
  <div class="admin-image-panel" style="margin-top: 1.5rem;">
    <div class="admin-image-panel__header">
      <h4>{{ 'admin.items.color_images' | translate }}</h4>
      <div class="admin-card__header-actions">
        <button 
          class="admin-button admin-button--ghost" 
          type="button" 
          [disabled]="!selectedColor"
          (click)="fileInput.click()">
          <i class="fas fa-upload" style="margin-right: 8px;"></i>
          {{ 'admin.items.upload' | translate }}
        </button>
        <input #fileInput type="file" multiple (change)="onImagesSelected($event)" style="display: none;" />
      </div>
    </div>
    <p class="admin-empty" *ngIf="!selectedColor">{{ 'admin.items.select_color_hint' | translate }}</p>
    <p class="admin-empty" *ngIf="isPhotosLoading">{{ 'admin.items.loading_images' | translate }}</p>
    <div class="admin-image-grid" *ngIf="selectedColor">
      <div class="admin-image-card" *ngFor="let image of getSelectedColorImages()">
        <div class="admin-image-card__img-wrapper">
          <img [src]="image.url" [alt]="('admin.items.id' | translate) + ' ' + image.id" />
          <button 
            class="admin-image-card__delete" 
            type="button" 
            [title]="'admin.items.delete_image' | translate"
            (click)="deleteImage(image.id)">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-template>
